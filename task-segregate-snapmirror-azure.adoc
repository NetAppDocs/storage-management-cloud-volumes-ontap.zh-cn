---
sidebar: sidebar 
permalink: task-segregate-snapmirror-azure.html 
keywords: segregate, SnapMirror, SnapMirror traffic, SnapMirror replication, add, additional NIC, new NIC, intercluster LIF, non-routable subnet, subnet 
summary: 借助 Azure 中的Cloud Volumes ONTAP ，您可以使用不同的网络隔离SnapMirror复制流量，以增强数据的安全性和性能。 
---
= 在 Azure 中隔离SnapMirror流量
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
使用 Azure 中的Cloud Volumes ONTAP ，您可以将SnapMirror复制流量与数据和管理流量分离。为了将SnapMirror复制流量与数据流量隔离，您需要添加一个新的网络接口卡 (NIC)、一个相关的集群间 LIF 和一个不可路由的子网。



== 关于 Azure 中的SnapMirror流量隔离

默认情况下， NetApp控制台会在同一子网上配置Cloud Volumes ONTAP部署中的所有 NIC 和 LIF。在这样的配置中， SnapMirror复制流量和数据和管理流量使用相同的子网。隔离SnapMirror流量利用了无法路由到用于数据和管理流量的现有子网的额外子网。

.图 1
下图显示了在单节点部署中，使用附加 NIC、关联的集群间 LIF 和不可路由子网对SnapMirror复制流量进行隔离。  HA 对部署略有不同。

image:diagram-segregate-snapmirror-traffic.png["该图展示了单节点配置中SnapMirror复制流量的隔离"]

.开始之前
回顾以下注意事项：

* 您只能向Cloud Volumes ONTAP单节点或 HA 对部署（VM 实例）添加单个 NIC 以实现SnapMirror流量隔离。
* 要添加新的 NIC，您部署的 VM 实例类型必须具有未使用的 NIC。
* 源集群和目标集群应该可以访问同一个虚拟网络 (VNet)。目标集群是 Azure 中的Cloud Volumes ONTAP系统。源集群可以是 Azure 中的Cloud Volumes ONTAP系统或ONTAP系统。




== 步骤 1：创建额外的 NIC 并连接到目标 VM

本节提供有关如何创建附加 NIC 并将其附加到目标 VM 的说明。目标 VM 是 Azure 中Cloud Volumes ONTAP中的单节点或 HA 对系统，您要在其中设置额外的 NIC。

.步骤
. 在ONTAP CLI 中，停止该节点。
+
[source, cli]
----
dest::> halt -node <dest_node-vm>
----
. 在 Azure 门户中，检查 VM（节点）状态是否已停止。
+
[source, cli]
----
az vm get-instance-view --resource-group <dest-rg> --name <dest-vm> --query instanceView.statuses[1].displayStatus
----
. 使用 Azure Cloud Shell 中的 Bash 环境停止节点。
+
.. 停止节点。
+
[source, cli]
----
az vm stop --resource-group <dest_node-rg> --name <dest_node-vm>
----
.. 解除分配节点。
+
[source, cli]
----
az vm deallocate --resource-group <dest_node-rg> --name <dest_node-vm>
----


. 配置网络安全组规则，使两个子网（源集群子网和目标集群子网）互不可达。
+
.. 在目标虚拟机上创建新的 NIC。
.. 查找源集群子网的子网 ID。
+
[source, cli]
----
az network vnet subnet show -g <src_vnet-rg> -n <src_subnet> --vnet-name <vnet> --query id
----
.. 使用源集群子网的子网 ID 在目标虚拟机上创建新的 NIC。在这里输入新 NIC 的名称。
+
[source, cli]
----
az network nic create -g <dest_node-rg> -n <dest_node-vm-nic-new> --subnet <id_from_prev_command> --accelerated-networking true
----
.. 保存私有IP地址。此 IP 地址 <new_added_nic_primary_addr> 用于在<<Step 2: Create a new IPspace,广播域，新 NIC 的集群间 LIF>>。


. 将新的 NIC 附加到 VM。
+
[source, cli]
----
az vm nic add -g <dest_node-rg> --vm-name <dest_node-vm> --nics <dest_node-vm-nic-new>
----
. 启动虚拟机（节点）。
+
[source, cli]
----
az vm start --resource-group <dest_node-rg>  --name <dest_node-vm>
----
. 在 Azure 门户中，转到 *网络* 并确认新 NIC（例如 nic-new）存在并且加速网络已启用。
+
[source, cli]
----
az network nic list --resource-group azure-59806175-60147103-azure-rg --query "[].{NIC: name, VM: virtualMachine.id}"
----


对于 HA 对部署，请对合作伙伴节点重复这些步骤。



== 步骤 2：为新 NIC 创建新的 IP 空间、广播域和集群间 LIF

集群间 LIF 的单独 IP 空间为集群间复制的网络功能提供了逻辑分离。

使用ONTAP CLI 执行以下步骤。

.步骤
. 创建新的 IP 空间（new_ipspace）。
+
[source, cli]
----
dest::> network ipspace create -ipspace <new_ipspace>
----
. 在新的 IP 空间（new_ipspace）上创建一个广播域并添加 nic-new 端口。
+
[source, cli]
----
dest::> network port show
----
. 对于单节点系统，新添加的端口是_e0b_。对于具有托管磁盘的 HA 对部署，新添加的端口是 _e0d_。对于具有页 Blob 的 HA 对部署，新添加的端口是 _e0e_。使用节点名称而不是虚拟机名称。通过运行查找节点名称 `node show`。
+
[source, cli]
----
dest::> broadcast-domain create -broadcast-domain <new_bd> -mtu 1500 -ipspace <new_ipspace> -ports <dest_node-cot-vm:e0b>
----
. 在新的广播域 (new_bd) 和新的 NIC (nic-new) 上创建集群间 LIF。
+
[source, cli]
----
dest::> net int create -vserver <new_ipspace> -lif <new_dest_node-ic-lif> -service-policy default-intercluster -address <new_added_nic_primary_addr> -home-port <e0b> -home-node <node> -netmask <new_netmask_ip> -broadcast-domain <new_bd>
----
. 验证新的集群间 LIF 的创建。
+
[source, cli]
----
dest::> net int show
----


对于 HA 对部署，请对合作伙伴节点重复这些步骤。



== 步骤 3：验证源系统和目标系统之间的集群对等连接

本节提供有关如何验证源系统和目标系统之间的对等关系的说明。

使用ONTAP CLI 执行以下步骤。

.步骤
. 验证目标集群的集群间 LIF 是否可以对源集群的集群间 LIF 执行 ping 操作。由于目标集群执行此命令，因此目标 IP 地址是源上的集群间 LIF IP 地址。
+
[source, cli]
----
dest::> ping -lif <new_dest_node-ic-lif> -vserver <new_ipspace> -destination <10.161.189.6>
----
. 验证源集群的集群间 LIF 是否可以 ping 通目标集群的集群间 LIF。目标是在目标上创建的新 NIC 的 IP 地址。
+
[source, cli]
----
src::> ping -lif <src_node-ic-lif> -vserver <src_svm> -destination <10.161.189.18>
----


对于 HA 对部署，请对合作伙伴节点重复这些步骤。



== 步骤 4：在源系统和目标系统之间创建 SVM 对等连接

本节提供有关如何在源系统和目标系统之间创建 SVM 对等的说明。

使用ONTAP CLI 执行以下步骤。

.步骤
. 使用源集群间 LIF IP 地址作为目标在目标上创建集群对等 `-peer-addrs`。对于 HA 对，列出两个节点的源集群间 LIF IP 地址作为 `-peer-addrs`。
+
[source, cli]
----
dest::> cluster peer create -peer-addrs <10.161.189.6> -ipspace <new_ipspace>
----
. 输入并确认密码。
. 使用目标集群 LIF IP 地址作为源集群的 IP 地址，在源上创建集群对等连接 `peer-addrs`。对于 HA 对，列出两个节点的目标集群间 LIF IP 地址作为 `-peer-addrs`。
+
[source, cli]
----
src::> cluster peer create -peer-addrs <10.161.189.18>
----
. 输入并确认密码。
. 检查集群是否对等。
+
[source, cli]
----
src::> cluster peer show
----
+
成功的对等连接在可用性字段中显示 *可用*。

. 在目标上创建 SVM 对等连接。源 SVM 和目标 SVM 都应该是数据 SVM。
+
[source, cli]
----
dest::> vserver peer create -vserver <dest_svm> -peer-vserver <src_svm> -peer-cluster <src_cluster> -applications snapmirror``
----
. 接受 SVM 对等连接。
+
[source, cli]
----
src::> vserver peer accept -vserver <src_svm> -peer-vserver <dest_svm>
----
. 检查 SVM 是否对等。
+
[source, cli]
----
dest::> vserver peer show
----
+
同行国家显示*`peered`* 和对等应用程序显示*`snapmirror`*.





== 步骤 5：在源系统和目标系统之间创建SnapMirror复制关系

本节提供有关如何在源系统和目标系统之间创建SnapMirror复制关系的说明。

要移动现有的SnapMirror复制关系，必须先中断现有的SnapMirror复制关系，然后再创建新的SnapMirror复制关系。

使用ONTAP CLI 执行以下步骤。

.步骤
. 在目标 SVM 上创建数据保护卷。
+
[source, cli]
----
dest::> vol create -volume <new_dest_vol> -vserver <dest_svm> -type DP -size <10GB> -aggregate <aggr1>
----
. 在目标上创建SnapMirror复制关系，其中包括复制的SnapMirror策略和计划。
+
[source, cli]
----
dest::> snapmirror create -source-path src_svm:src_vol  -destination-path  dest_svm:new_dest_vol -vserver dest_svm -policy MirrorAllSnapshots -schedule 5min
----
. 在目标上初始化SnapMirror复制关系。
+
[source, cli]
----
dest::> snapmirror initialize -destination-path  <dest_svm:new_dest_vol>
----
. 在ONTAP CLI 中，通过运行以下命令验证SnapMirror关系状态：
+
[source, cli]
----
dest::> snapmirror show
----
+
关系状态是 `Snapmirrored`关系的健康是 `true`。

. 可选：在ONTAP CLI 中，运行以下命令查看SnapMirror关系的操作历史记录。
+
[source, cli]
----
dest::> snapmirror show-history
----


或者，您可以挂载源卷和目标卷，将文件写入源卷，并验证卷是否复制到目标卷。
