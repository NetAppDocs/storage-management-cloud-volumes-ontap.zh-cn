---
sidebar: sidebar 
permalink: task-managing-svms-aws.html 
keywords: storage virtual machine, vserver, svm, storage vm, supported number, number supported 
summary: 存储虚拟机是在ONTAP内运行的虚拟机，可为您的客户端提供存储和数据服务。您可能知道这是 SVM 或 vserver。  Cloud Volumes ONTAP默认配置一个存储虚拟机，但某些配置支持额外的存储虚拟机。 
---
= 管理 AWS 中Cloud Volumes ONTAP的数据服务存储虚拟机
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
存储虚拟机是在ONTAP内运行的虚拟机，可为您的客户端提供存储和数据服务。您可能知道这是一个_SVM_或_vserver_。  Cloud Volumes ONTAP默认配置一个存储虚拟机，但某些配置支持额外的存储虚拟机。

要创建额外的数据服务存储虚拟机，您需要在 AWS 中分配 IP 地址，然后根据您的Cloud Volumes ONTAP配置运行ONTAP命令。



== 支持的存储虚拟机数量

从 9.7 版本开始，特定的Cloud Volumes ONTAP配置支持多个存储虚拟机。前往 https://docs.netapp.com/us-en/cloud-volumes-ontap-relnotes/index.html["Cloud Volumes ONTAP发行说明"^]验证您的Cloud Volumes ONTAP版本支持的存储虚拟机数量。

所有其他Cloud Volumes ONTAP配置都支持一个数据服务存储虚拟机和一个用于灾难恢复的目标存储虚拟机。如果源存储虚拟机发生中断，您可以激活目标存储虚拟机进行数据访问。



== 验证配置的限制

每个 EC2 实例支持每个网络接口的最大私有 IPv4 地址数量。在 AWS 中为新的存储虚拟机分配 IP 地址之前，您需要验证限制。

.步骤
. 去 https://docs.netapp.com/us-en/cloud-volumes-ontap-relnotes/reference-limits-aws.html["Cloud Volumes ONTAP发行说明中的​​存储限制部分"^]。
. 确定您的实例类型每个接口的最大 IP 地址数。
. 记下这个号码，因为在下一节中分配 AWS 中的 IP 地址时需要它。




== 在 AWS 中分配 IP 地址

在为新的存储虚拟机创建 LIF 之前，必须将私有 IPv4 地址分配给 AWS 中的端口 e0a。

请注意，存储虚拟机的可选管理 LIF 需要单节点系统上和单个 AZ 中的 HA 对上的专用 IP 地址。此管理 LIF 提供与SnapCenter等管理工具的连接。

.步骤
. 登录AWS并开启EC2服务。
. 选择Cloud Volumes ONTAP实例并单击 *网络*。
+
如果您要在 HA 对上创建存储虚拟机，请选择节点 1。

. 向下滚动到*网络接口*并单击端口 e0a 的*接口 ID*。
+
image:screenshot_aws_e0a.gif["AWS 控制台的屏幕截图，显示网络接口上的端口 e0a。"]

. 选择网络接口并单击*操作>管理 IP 地址*。
. 展开 e0a 的 IP 地址列表。
. 验证 IP 地址：
+
.. 计算已分配的 IP 地址数量，以确认端口是否有空间容纳额外的 IP。
+
您应该已经在本页的上一节中确定了每个接口支持的最大 IP 地址数量。

.. 可选：转到Cloud Volumes ONTAP的ONTAP CLI 并运行 *network interface show* 以确认每个 IP 地址都在使用中。
+
如果 IP 地址未被使用，那么您可以将其与新的存储 VM 一起使用。



. 返回 AWS 控制台，单击“分配新 IP 地址”以根据新存储 VM 所需的数量分配其他 IP 地址。
+
** 单节点系统：需要一个未使用的辅助私有IP。
+
如果您想在存储虚拟机上创建管理 LIF，则需要可选的辅助私有 IP。

** 单个 AZ 中的 HA 对：节点 1 上需要一个未使用的辅助私有 IP。
+
如果您想在存储虚拟机上创建管理 LIF，则需要可选的辅助私有 IP。

** 多个可用区中的 HA 对：每个节点都需要一个未使用的辅助私有 IP。


. 如果您要在单个 AZ 中的 HA 对上分配 IP 地址，请启用*允许重新分配辅助私有 IPv4 地址*。
. 单击“保存”。
. 如果您在多个可用区中有一个 HA 对，则需要对节点 2 重复这些步骤。




== 在单节点系统上创建存储虚拟机

这些步骤在单节点系统上创建一个新的存储虚拟机。创建 NAS LIF 需要一个私有 IP 地址，如果要创建管理 LIF，则需要另一个可选的私有 IP 地址。

.步骤
. 创建存储虚拟机和到存储虚拟机的路由。
+
[source, cli]
----
vserver create -rootvolume-security-style unix -rootvolume root_svm_2 -snapshot-policy default -vserver svm_2 -aggregate aggr1
----
+
[source, cli]
----
network route create -destination 0.0.0.0/0 -vserver svm_2 -gateway subnet_gateway
----
. 创建 NAS LIF。
+
[source, cli]
----
network interface create -auto-revert true -vserver svm_2 -service-policy default-data-files -home-port e0a -address private_ip_x -netmask node1Mask -lif ip_nas_2 -home-node cvo-node
----
+
其中 _private_ip_x_ 是 e0a 上未使用的辅助私有 IP。

. 可选：创建存储虚拟机管理 LIF。
+
[source, cli]
----
network interface create -auto-revert true -vserver svm_2 -service-policy default-management -home-port e0a -address private_ip_y -netmask node1Mask -lif ip_svm_mgmt_2 -home-node cvo-node
----
+
其中 _private_ip_y_ 是 e0a 上另一个未使用的辅助私有 IP。

. 将一个或多个聚合分配给存储虚拟机。
+
[source, cli]
----
vserver add-aggregates -vserver svm_2 -aggregates aggr1,aggr2
----
+
此步骤是必需的，因为新的存储虚拟机需要访问至少一个聚合，然后您才能在存储虚拟机上创建卷。





== 在单个可用区内的 HA 对上创建存储虚拟机

这些步骤在单个 AZ 中的 HA 对上创建一个新的存储虚拟机。创建 NAS LIF 需要一个私有 IP 地址，如果要创建管理 LIF，则需要另一个可选的私有 IP 地址。

这两个 LIF 都分配在节点 1 上。如果发生故障，私有 IP 地址可以在节点之间移动。

.步骤
. 创建存储虚拟机和到存储虚拟机的路由。
+
[source, cli]
----
vserver create -rootvolume-security-style unix -rootvolume root_svm_2 -snapshot-policy default -vserver svm_2 -aggregate aggr1
----
+
[source, cli]
----
network route create -destination 0.0.0.0/0 -vserver svm_2 -gateway subnet_gateway
----
. 在节点 1 上创建 NAS LIF。
+
[source, cli]
----
network interface create -auto-revert true -vserver svm_2 -service-policy default-data-files -home-port e0a -address private_ip_x -netmask node1Mask -lif ip_nas_2 -home-node cvo-node1
----
+
其中 _private_ip_x_ 是 cvo-node1 的 e0a 上未使用的辅助私有 IP。在接管的情况下，该 IP 地址可以重新定位到 cvo-node2 的 e0a，因为服务策略 default-data-files 表明 IP 可以迁移到合作伙伴节点。

. 可选：在节点 1 上创建存储虚拟机管理 LIF。
+
[source, cli]
----
network interface create -auto-revert true -vserver svm_2 -service-policy default-management -home-port e0a -address private_ip_y -netmask node1Mask -lif ip_svm_mgmt_2 -home-node cvo-node1
----
+
其中 _private_ip_y_ 是 e0a 上另一个未使用的辅助私有 IP。

. 将一个或多个聚合分配给存储虚拟机。
+
[source, cli]
----
vserver add-aggregates -vserver svm_2 -aggregates aggr1,aggr2
----
+
此步骤是必需的，因为新的存储虚拟机需要访问至少一个聚合，然后您才能在存储虚拟机上创建卷。

. 如果您运行的是Cloud Volumes ONTAP 9.11.1 或更高版本，请修改存储虚拟机的网络服务策略。
+
需要修改服务，因为它可以确保Cloud Volumes ONTAP可以使用 iSCSI LIF 进行出站管理连接。

+
[source, cli]
----
network interface service-policy remove-service -vserver <svm-name> -policy default-data-files -service data-fpolicy-client
network interface service-policy remove-service -vserver <svm-name> -policy default-data-files -service management-ad-client
network interface service-policy remove-service -vserver <svm-name> -policy default-data-files -service management-dns-client
network interface service-policy remove-service -vserver <svm-name> -policy default-data-files -service management-ldap-client
network interface service-policy remove-service -vserver <svm-name> -policy default-data-files -service management-nis-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-blocks -service data-fpolicy-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-blocks -service management-ad-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-blocks -service management-dns-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-blocks -service management-ldap-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-blocks -service management-nis-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-iscsi -service data-fpolicy-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-iscsi -service management-ad-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-iscsi -service management-dns-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-iscsi -service management-ldap-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-iscsi -service management-nis-client
----




== 在多个可用区的 HA 对上创建存储虚拟机

这些步骤在多个 AZ 中的 HA 对上创建一个新的存储虚拟机。

对于 NAS LIF 来说，浮动 IP 地址是必需的，而对于管理 LIF 来说，浮动 IP 地址是可选的。这些浮动 IP 地址不需要您在 AWS 中分配私有 IP。相反，浮动 IP 会在 AWS 路由表中自动配置为指向同一 VPC 中特定节点的 ENI。

为了使浮动 IP 与ONTAP一起工作，必须在每个节点上的每个存储虚拟机上配置一个私有 IP 地址。这反映在以下步骤中，其中在节点 1 和节点 2 上创建 iSCSI LIF。

.步骤
. 创建存储虚拟机和到存储虚拟机的路由。
+
[source, cli]
----
vserver create -rootvolume-security-style unix -rootvolume root_svm_2 -snapshot-policy default -vserver svm_2 -aggregate aggr1
----
+
[source, cli]
----
network route create -destination 0.0.0.0/0 -vserver svm_2 -gateway subnet_gateway
----
. 在节点 1 上创建 NAS LIF。
+
[source, cli]
----
network interface create -auto-revert true -vserver svm_2 -service-policy default-data-files -home-port e0a -address floating_ip -netmask node1Mask -lif ip_nas_floating_2 -home-node cvo-node1
----
+
** 浮动 IP 地址必须位于您部署 HA 配置的 AWS 区域中的所有 VPC 的 CIDR 块之外。 192.168.209.27 是一个示例浮动 IP 地址。link:reference-networking-aws.html#requirements-for-ha-pairs-in-multiple-azs["了解有关选择浮动 IP 地址的更多信息"] 。
** `-service-policy default-data-files`表示 IP 可以迁移到伙伴节点。


. 可选：在节点 1 上创建存储虚拟机管理 LIF。
+
[source, cli]
----
network interface create -auto-revert true -vserver svm_2 -service-policy default-management -home-port e0a -address floating_ip -netmask node1Mask -lif ip_svm_mgmt_2 -home-node cvo-node1
----
. 在节点 1 上创建 iSCSI LIF。
+
[source, cli]
----
network interface create -vserver svm_2 -service-policy default-data-blocks -home-port e0a -address private_ip -netmask nodei1Mask -lif ip_node1_iscsi_2 -home-node cvo-node1
----
+
** 此 iSCSI LIF 需要支持存储虚拟机中浮动 IP 的 LIF 迁移。它不必是 iSCSI LIF，但不能配置为在节点之间迁移。
** `-service-policy default-data-block`表示IP地址不会在节点之间迁移。
** _private_ip_ 是 cvo_node1 的 eth0 (e0a) 上未使用的辅助私有 IP 地址。


. 在节点 2 上创建 iSCSI LIF。
+
[source, cli]
----
network interface create -vserver svm_2 -service-policy default-data-blocks -home-port e0a -address private_ip -netmaskNode2Mask -lif ip_node2_iscsi_2 -home-node cvo-node2
----
+
** 此 iSCSI LIF 需要支持存储虚拟机中浮动 IP 的 LIF 迁移。它不必是 iSCSI LIF，但不能配置为在节点之间迁移。
** `-service-policy default-data-block`表示IP地址不会在节点之间迁移。
** _private_ip_ 是 cvo_node2 的 eth0 (e0a) 上未使用的辅助私有 IP 地址。


. 将一个或多个聚合分配给存储虚拟机。
+
[source, cli]
----
vserver add-aggregates -vserver svm_2 -aggregates aggr1,aggr2
----
+
此步骤是必需的，因为新的存储虚拟机需要访问至少一个聚合，然后您才能在存储虚拟机上创建卷。

. 如果您运行的是Cloud Volumes ONTAP 9.11.1 或更高版本，请修改存储虚拟机的网络服务策略。
+
需要修改服务，因为它可以确保Cloud Volumes ONTAP可以使用 iSCSI LIF 进行出站管理连接。

+
[source, cli]
----
network interface service-policy remove-service -vserver <svm-name> -policy default-data-files -service data-fpolicy-client
network interface service-policy remove-service -vserver <svm-name> -policy default-data-files -service management-ad-client
network interface service-policy remove-service -vserver <svm-name> -policy default-data-files -service management-dns-client
network interface service-policy remove-service -vserver <svm-name> -policy default-data-files -service management-ldap-client
network interface service-policy remove-service -vserver <svm-name> -policy default-data-files -service management-nis-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-blocks -service data-fpolicy-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-blocks -service management-ad-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-blocks -service management-dns-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-blocks -service management-ldap-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-blocks -service management-nis-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-iscsi -service data-fpolicy-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-iscsi -service management-ad-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-iscsi -service management-dns-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-iscsi -service management-ldap-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-iscsi -service management-nis-client
----

