---
sidebar: sidebar 
permalink: task-deploy-aws-shared-vpc.html 
keywords: shared vpc, aws shared vpc, vpc sharing, shared subnet, deploy shared vpc, assume role 
summary: 从 9.11.1 版本开始，AWS 通过 VPC 共享支持Cloud Volumes ONTAP HA 对。 VPC 共享使您的组织能够与其他 AWS 账户共享子网。要使用此配置，您必须设置您的 AWS 环境，然后使用 API 部署 HA 对。 
---
= 在 AWS 共享子网中部署Cloud Volumes ONTAP HA 对
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
从 9.11.1 版本开始，AWS 通过 VPC 共享支持Cloud Volumes ONTAP HA 对。 VPC 共享使您的组织能够与其他 AWS 账户共享子网。要使用此配置，您必须设置您的 AWS 环境，然后使用 API 部署 HA 对。

和 https://aws.amazon.com/blogs/networking-and-content-delivery/vpc-sharing-a-new-approach-to-multiple-accounts-and-vpc-management/["VPC共享"^]， Cloud Volumes ONTAP HA 配置分布在两个帐户中：

* VPC 所有者账户，拥有网络（VPC、子网、路由表和Cloud Volumes ONTAP安全组）
* 参与者账户，其中 EC2 实例部署在共享子网中（这包括两个 HA 节点和中介者）


对于跨多个可用区部署的Cloud Volumes ONTAP HA 配置，HA 中介需要特定权限才能写入 VPC 所有者帐户中的路由表。您需要通过设置调解员可以承担的 IAM 角色来提供这些权限。

下图显示了此部署所涉及的组件：

image:diagram-aws-vpc-sharing.png["共享 VPC 中Cloud Volumes ONTAP HA 部署的概念图。它显示了 VPC 所有者帐户和参与者帐户可用的共享 VPC。共享 VPC 包括 IAM 角色、路由表、安全组和三个共享子网。参与者帐户包括Cloud Volumes ONTAP HA 配置和附加到调解器的 IAM 角色。"]

按照以下步骤所述，您需要与参与者账户共享子网，然后在 VPC 所有者账户中创建 IAM 角色和安全组。

当您创建Cloud Volumes ONTAP系统时， NetApp控制台会自动创建 IAM 角色并将其附加到中介器。此角色承担您在 VPC 所有者账户中创建的 IAM 角色，以便对与 HA 对关联的路由表进行更改。

.步骤
. 与参与者账户共享 VPC 所有者账户中的子网。
+
此步骤是在共享子网中部署 HA 对所必需的。

+
https://docs.aws.amazon.com/vpc/latest/userguide/vpc-sharing.html#vpc-sharing-share-subnet["AWS 文档：共享子网"^]

. 在 VPC 所有者账户中，为Cloud Volumes ONTAP创建一个安全组。
+
link:reference-security-groups.html["请参阅Cloud Volumes ONTAP的安全组规则"] 。请注意，您不需要为 HA 中介创建安全组。控制台会为您完成该操作。

. 在 VPC 所有者账户中，创建一个包含以下权限的 IAM 角色：
+
[source, json]
----
Action": [
                "ec2:AssignPrivateIpAddresses",
                "ec2:CreateRoute",
                "ec2:DeleteRoute",
                "ec2:DescribeNetworkInterfaces",
                "ec2:DescribeRouteTables",
                "ec2:DescribeVpcs",
                "ec2:ReplaceRoute",
                "ec2:UnassignPrivateIpAddresses"
----
. 使用 API 创建新的Cloud Volumes ONTAP系统。
+
请注意，您必须指定以下字段：

+
** “安全组 ID”
+
“securityGroupId”字段应指定您在 VPC 所有者帐户中创建的安全组（请参阅上面的步骤 2）。

** “haParams”对象中的“assumeRoleArn”
+
“assumeRoleArn”字段应包括您在 VPC 所有者账户中创建的 IAM 角色的 ARN（请参阅上面的步骤 3）。

+
例如：

+
[source, json]
----
"haParams": {
     "assumeRoleArn": "arn:aws:iam::642991768967:role/mediator_role_assume_fromdev"
}
----
+
https://docs.netapp.com/us-en/bluexp-automation/cm/overview.html["了解Cloud Volumes ONTAP API"^]




